# STM32G4 Flash Programmer

ä¸€ä¸ªåŸºäºEmbassyæ¡†æ¶çš„STM32G4 USB CDC Flashç¼–ç¨‹å™¨ï¼Œç”¨äºé€šè¿‡USBè™šæ‹Ÿä¸²å£å¯¹å¤–éƒ¨SPI Flash (W25Q128)è¿›è¡Œè¯»å†™æ“ä½œã€‚

## ğŸš€ ç‰¹æ€§

- **USB CDCé€šä¿¡**: æ— éœ€é©±åŠ¨ï¼Œå³æ’å³ç”¨çš„è™šæ‹Ÿä¸²å£
- **å¼‚æ­¥å¤„ç†**: åŸºäºEmbassyæ¡†æ¶çš„é«˜æ•ˆå¼‚æ­¥æ“ä½œ
- **å¤§æ–‡ä»¶æ”¯æŒ**: æ”¯æŒ16MBæ–‡ä»¶çš„åˆ†å—ä¼ è¾“
- **å®Œæ•´æ€§ä¿è¯**: CRCæ ¡éªŒç¡®ä¿æ•°æ®ä¼ è¾“å¯é æ€§
- **è¿›åº¦æ˜¾ç¤º**: å®æ—¶æ˜¾ç¤ºä¼ è¾“è¿›åº¦å’Œé€Ÿåº¦
- **å¤šç§æ“ä½œ**: æ”¯æŒè¯»å–ã€å†™å…¥ã€æ“¦é™¤ã€éªŒè¯æ“ä½œ

## ğŸ“‹ é¡¹ç›®ç»“æ„

```
stm32g4-flash-programmer/
â”œâ”€â”€ firmware/           # STM32G4å›ºä»¶ (Embassy + USB CDC)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.rs
â”‚   â”‚   â”œâ”€â”€ flash_driver.rs
â”‚   â”‚   â”œâ”€â”€ protocol_handler.rs
â”‚   â”‚   â””â”€â”€ usb_cdc.rs
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”œâ”€â”€ memory.x
â”‚   â””â”€â”€ Embed.toml
â”œâ”€â”€ host-tool/          # PCç«¯å·¥å…· (Rust CLI)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.rs
â”‚   â”‚   â”œâ”€â”€ serial.rs
â”‚   â”‚   â””â”€â”€ commands.rs
â”‚   â””â”€â”€ Cargo.toml
â”œâ”€â”€ protocol/           # å…±äº«é€šä¿¡åè®®
â”‚   â”œâ”€â”€ src/lib.rs
â”‚   â””â”€â”€ Cargo.toml
â””â”€â”€ README.md
```

## ğŸ”Œ ç¡¬ä»¶è¿æ¥

### STM32G431CBU6 â†” W25Q128 SPI Flash

| W25Q128 å¼•è„š | STM32 å¼•è„š | åŠŸèƒ½ | ç‰©ç†å¼•è„š |
|-------------|-----------|------|---------|
| CS          | PB12      | SPI2_NSS | Pin 25 |
| CLK         | PB13      | SPI2_SCK | Pin 26 |
| DI (MOSI)   | PB15      | SPI2_MOSI| Pin 28 |
| DO (MISO)   | PB14      | SPI2_MISO| Pin 27 |
| VCC         | 3.3V      | ç”µæº     | - |
| GND         | GND       | åœ°çº¿     | - |

### USBè¿æ¥

| åŠŸèƒ½ | STM32 å¼•è„š |
|------|-----------|
| USB_DP | PA12 |
| USB_DM | PA11 |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä¸€é”®æ„å»ºå’Œæµ‹è¯•

```bash
# 1. æ„å»ºPCç«¯å·¥å…·
cargo build --release -p flash-programmer-tool

# 2. æ„å»ºå›ºä»¶ (éœ€è¦å…ˆè¿æ¥STM32G4å¼€å‘æ¿)
./build_firmware.sh

# 3. è¿è¡Œæµ‹è¯• (éœ€è¦è¿æ¥ç¡¬ä»¶å’ŒFlashèŠ¯ç‰‡)
./test_example.sh
```

## ğŸ› ï¸ è¯¦ç»†ç¼–è¯‘æ­¥éª¤

### ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£… Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# æ·»åŠ  ARM Cortex-M4 ç›®æ ‡
rustup target add thumbv7em-none-eabihf

# å®‰è£… probe-rs
cargo install probe-rs --features cli
```

### ç¼–è¯‘å›ºä»¶

```bash
cd firmware
cargo build --release --target thumbv7em-none-eabihf
```

### çƒ§å½•å›ºä»¶

```bash
cd firmware
probe-rs download --chip STM32G431CBUx target/thumbv7em-none-eabihf/release/stm32g4-flash-programmer
```

### ç¼–è¯‘PCç«¯å·¥å…·

```bash
cargo build --release -p flash-programmer-tool
```

## ğŸ“¡ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬å‘½ä»¤

```bash
# å†™å…¥æ–‡ä»¶ (é«˜é€Ÿæ¨¡å¼)
./target/release/stm32g4-flash-tool --port /dev/cu.usbmodem412302 write --file firmware.bin --address 0x0

# å†™å…¥æ–‡ä»¶å¹¶éªŒè¯æ•°æ®å®Œæ•´æ€§
./target/release/stm32g4-flash-tool --port /dev/cu.usbmodem412302 write --file firmware.bin --address 0x0 --verify

# è¯»å–Flashæ•°æ®
./target/release/stm32g4-flash-tool --port /dev/cu.usbmodem412302 read --address 0x0 --size 1024 --output data.bin
```

### ğŸ¨ å®Œæ•´èµ„æºç®¡ç†ç¤ºä¾‹

é¡¹ç›®åŒ…å«å®Œæ•´çš„W25Q128JV Flashèµ„æºç®¡ç†ç¤ºä¾‹ï¼Œæ”¯æŒå›¾ç‰‡ã€å­—ä½“ã€é…ç½®ç­‰èµ„æºçš„ç»Ÿä¸€ç®¡ç†ï¼š

```bash
# è¿›å…¥ç¤ºä¾‹ç›®å½•
cd examples/w25q128jv/tools

# 1. ç”Ÿæˆå¼€æœºå±å¹• (320x172 RGB565)
python3 svg_to_rgb565.py

# 2. ç”Ÿæˆä¸­æ–‡å­—ä½“ä½å›¾ (æ–‡æ³‰é©¿12pxï¼Œ2094ä¸ªå­—ç¬¦)
python3 font_converter.py

# 3. ç”Ÿæˆèµ„æºå¸ƒå±€é…ç½®
python3 resource_manager.py

# 4. åˆæˆå®Œæ•´16MB Flashé•œåƒ
python3 flash_composer.py

# 5. ç¼–ç¨‹åˆ°FlashèŠ¯ç‰‡ (16MBï¼Œçº¦26åˆ†é’Ÿ)
cd ../../../host-tool
time cargo run --release -- --port /dev/cu.usbmodem412302 write --file ../examples/w25q128jv/w25q128jv_complete.bin --address 0x0
```

### ğŸ“‹ èµ„æºç®¡ç†åŠŸèƒ½

| èµ„æºç±»å‹ | åœ°å€èŒƒå›´ | å¤§å° | æè¿° |
|---------|---------|------|------|
| å¼€æœºå±å¹• | 0x00000000-0x0001ADFF | 110KB | 320x172 RGB565ä½å›¾ |
| å­—ä½“æ•°æ® | 0x00020000-0x0021FFFF | 2MB | ä¸­æ–‡å­—ä½“ä½å›¾ (2094å­—ç¬¦) |
| UIå›¾å½¢ | 0x00220000-0x0041FFFF | 2MB | UIå›¾æ ‡å’Œå›¾å½¢èµ„æº |
| åº”ç”¨æ•°æ® | 0x00420000-0x0071FFFF | 3MB | åº”ç”¨ç¨‹åºæ•°æ®å­˜å‚¨ |
| ç”¨æˆ·é…ç½® | 0x00720000-0x0072FFFF | 64KB | ç”¨æˆ·è®¾ç½®å’Œé…ç½® |
| æ—¥å¿—å­˜å‚¨ | 0x00730000-0x0074FFFF | 128KB | ç³»ç»Ÿå’Œé”™è¯¯æ—¥å¿— |
| å›ºä»¶æ›´æ–° | 0x00750000-0x007CFFFF | 512KB | å›ºä»¶æ›´æ–°å­˜å‚¨åŒº |
| é¢„ç•™ç©ºé—´ | 0x007D0000-0x00FFFFFF | 8.2MB | æœªæ¥æ‰©å±•é¢„ç•™ |

## ğŸ”§ é€šä¿¡åè®®

### æ•°æ®åŒ…æ ¼å¼

```
å‘½ä»¤åŒ…: [MAGIC:2][CMD:1][LEN:4][ADDR:4][DATA:LEN][CRC:2]
å“åº”åŒ…: [MAGIC:2][STATUS:1][LEN:4][DATA:LEN][CRC:2]
```

### æ”¯æŒçš„å‘½ä»¤

- **INFO (0x01)**: è·å–Flashä¿¡æ¯
- **ERASE (0x02)**: æ“¦é™¤FlashåŒºåŸŸ
- **WRITE (0x03)**: å†™å…¥æ•°æ®åˆ°Flash
- **READ (0x04)**: ä»Flashè¯»å–æ•°æ®
- **VERIFY (0x05)**: éªŒè¯æ•°æ®å®Œæ•´æ€§

### çŠ¶æ€ç 

- **SUCCESS (0x00)**: æ“ä½œæˆåŠŸ
- **INVALID_COMMAND (0x01)**: æ— æ•ˆå‘½ä»¤
- **INVALID_ADDRESS (0x02)**: æ— æ•ˆåœ°å€
- **FLASH_ERROR (0x03)**: Flashæ“ä½œå¤±è´¥
- **CRC_ERROR (0x04)**: CRCæ ¡éªŒå¤±è´¥
- **BUFFER_OVERFLOW (0x05)**: ç¼“å†²åŒºæº¢å‡º
- **TIMEOUT (0x06)**: æ“ä½œè¶…æ—¶

## âš¡ æ€§èƒ½æ•°æ®

### ğŸ† å®æµ‹æ€§èƒ½æŒ‡æ ‡ (å·²ä¼˜åŒ–)

| æ–‡ä»¶å¤§å° | ä¼ è¾“æ—¶é—´ | å¹³å‡é€Ÿåº¦ | æˆåŠŸç‡ | æµ‹è¯•çŠ¶æ€ |
|---------|---------|---------|--------|---------|
| 1KB     | <1ç§’    | ç¬æ—¶å®Œæˆ | 100%   | âœ… å·²éªŒè¯ |
| 1MB     | 1åˆ†32ç§’  | 11.4 KB/s | 100%  | âœ… å·²éªŒè¯ |
| 16MB    | 26åˆ†9ç§’  | 10.7 KB/s | 100%  | âœ… å·²éªŒè¯ |

### ğŸš€ æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

- **æ‰¹é‡ä¼ è¾“**: 16åŒ…æ‰¹é‡å‘é€ï¼Œæœ€å¤§åŒ–USBååé‡
- **åŒç¼“å†²ç³»ç»Ÿ**: 4KBåŒç¼“å†²ï¼Œå‡å°‘å†…å­˜æ‹·è´å¼€é”€
- **æµå¼å†™å…¥**: æ— ACKç­‰å¾…ï¼Œæ¶ˆé™¤å¾€è¿”å»¶è¿Ÿ
- **æ™ºèƒ½é”™è¯¯å¤„ç†**: ä¼˜é›…å¤„ç†ä¼ è¾“å¼‚å¸¸
- **CRC32æ ¡éªŒ**: ç«¯åˆ°ç«¯æ•°æ®å®Œæ•´æ€§éªŒè¯

### ğŸ“Š æ€§èƒ½å¯¹æ¯”

| ä¼˜åŒ–é˜¶æ®µ | ä¼ è¾“é€Ÿåº¦ | æå‡å¹…åº¦ | å…³é”®æŠ€æœ¯ |
|---------|---------|---------|---------|
| åˆå§‹ç‰ˆæœ¬ | 4.6 KB/s | åŸºå‡† | åŸºç¡€USB CDC |
| æ‰¹é‡ä¼˜åŒ– | 8.5 KB/s | +85% | 16åŒ…æ‰¹é‡ä¼ è¾“ |
| åŒç¼“å†²ä¼˜åŒ– | 11.4 KB/s | +148% | 4KBåŒç¼“å†² + æµå¼ä¼ è¾“ |

### ğŸ’¾ å†…å­˜ä½¿ç”¨

- **STM32G4 RAM**: çº¦12KBç”¨äºåŒç¼“å†²å’Œåè®®æ ˆ
- **ä¸»æœºå†…å­˜**: çº¦2MBç”¨äºæ–‡ä»¶ç¼“å­˜å’Œè¿›åº¦æ˜¾ç¤º
- **Flashå¸ƒå±€**: æ”¯æŒå®Œæ•´16MB FlashèŠ¯ç‰‡ç®¡ç†

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è®¾å¤‡æœªè¯†åˆ«**
   - æ£€æŸ¥USBè¿æ¥
   - ç¡®è®¤å›ºä»¶å·²æ­£ç¡®çƒ§å½•
   - åœ¨Linuxä¸‹æ£€æŸ¥è®¾å¤‡æƒé™

2. **Flashæ“ä½œå¤±è´¥**
   - æ£€æŸ¥SPIè¿æ¥
   - ç¡®è®¤FlashèŠ¯ç‰‡å‹å·
   - æ£€æŸ¥ç”µæºç¨³å®šæ€§

3. **ä¼ è¾“é”™è¯¯**
   - æ£€æŸ¥USBçº¿ç¼†è´¨é‡
   - å°è¯•é™ä½ä¼ è¾“å—å¤§å°
   - æ£€æŸ¥ç³»ç»ŸUSBé©±åŠ¨

### è°ƒè¯•æ¨¡å¼

å›ºä»¶åŒ…å«defmtæ—¥å¿—è¾“å‡ºï¼Œå¯ä»¥é€šè¿‡probe-rsæŸ¥çœ‹ï¼š

```bash
cd firmware
probe-rs attach --chip STM32G431CBUx
```

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

---

**ğŸ¾ Made with â¤ï¸ by é¸£æ¿‘ç™½ç¾½ (çŒ«å¨˜å¿ƒç¾½)**
